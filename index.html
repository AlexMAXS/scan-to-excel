<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>扫描转Excel工具</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://docs.opencv.org/4.7.0/opencv.js"></script>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);color:#e2e8f0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.container{width:100%;max-width:800px;background:rgba(15,23,42,.7);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.3);overflow:hidden;border:1px solid rgba(94,234,212,.2)}
.header{background:linear-gradient(135deg,#0ea5e9 0%,#0d9488 100%);padding:30px;text-align:center;position:relative;overflow:hidden}
.header::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg,transparent 49%,rgba(255,255,255,.1) 50%,transparent 51%);background-size:20px 20px;opacity:.3;animation:movePattern 20s linear infinite}
@keyframes movePattern{0%{background-position:0 0}100%{background-position:40px 40px}}
.header h1{font-size:2.5em;margin-bottom:10px;text-shadow:0 2px 4px rgba(0,0,0,.2)}
.header p{font-size:1.1em;opacity:.9}
.content{padding:30px}
.upload-section{border:2px dashed #0ea5e9;border-radius:15px;padding:40px;text-align:center;background:rgba(14,165,233,.05);margin-bottom:30px;transition:all .3s ease}
.upload-section:hover{border-color:#5eead4;background:rgba(94,234,212,.1);transform:translateY(-3px);box-shadow:0 10px 25px rgba(14,165,233,.2)}
.upload-icon{font-size:4em;color:#0ea5e9;margin-bottom:20px;transition:all .3s ease}
.upload-section:hover .upload-icon{color:#5eead4;transform:scale(1.1)}
.file-input{display:none}
.upload-btn{background:linear-gradient(135deg,#0ea5e9 0%,#0d9488 100%);color:#fff;border:none;padding:15px 30px;border-radius:25px;font-size:1.1em;cursor:pointer;margin:10px;transition:all .3s ease;font-weight:600;letter-spacing:.5px;box-shadow:0 4px 15px rgba(14,165,233,.3)}
.upload-btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(14,165,233,.4)}
.camera-btn{background:linear-gradient(135deg,#8b5cf6 0%,#ec4899 100%)}
.camera-btn:hover{box-shadow:0 6px 20px rgba(139,92,246,.4)}
.result-section{display:none;margin-bottom:30px}
.data-table{width:100%;border-collapse:collapse;margin-bottom:20px;background:rgba(15,23,42,.5);border-radius:10px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,.2)}
.data-table th,.data-table td{border:1px solid rgba(94,234,212,.1);padding:12px;text-align:left}
.data-table th{background:linear-gradient(135deg,#0ea5e9 0%,#0d9488 100%);color:#fff;font-weight:600;position:sticky;top:0}
.data-table tr:nth-child(even){background:rgba(30,41,59,.5)}
.data-table tr:hover{background:rgba(14,165,233,.1)}
.data-table input{border:none;background:transparent;width:100%;padding:5px;font-size:1em;color:#e2e8f0}
.data-table input:focus{outline:2px solid #0ea5e9;background:rgba(14,165,233,.1);border-radius:3px}
.action-buttons{display:flex;gap:15px;justify-content:center;flex-wrap:wrap}
.action-btn{padding:12px 24px;border:none;border-radius:25px;cursor:pointer;font-size:1em;transition:all .3s ease;display:flex;align-items:center;gap:8px;font-weight:600;box-shadow:0 4px 10px rgba(0,0,0,.2)}
.export-btn{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff}
.export-btn:hover{transform:translateY(-3px);box-shadow:0 6px 15px rgba(16,185,129,.4)}
.reset-btn{background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff}
.reset-btn:hover{transform:translateY(-3px);box-shadow:0 6px 15px rgba(239,68,68,.4)}
.add-row-btn{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);color:#fff}
.add-row-btn:hover{transform:translateY(-3px);box-shadow:0 6px 15px rgba(245,158,11,.4)}
.settings-section{background:rgba(15,23,42,.5);border-radius:15px;padding:20px;margin-bottom:20px;border:1px solid rgba(94,234,212,.2)}
.settings-title{font-size:1.2em;font-weight:600;margin-bottom:15px;color:#5eead4;display:flex;align-items:center;gap:10px}
.setting-item{display:flex;align-items:center;margin-bottom:15px;gap:15px}
.setting-item label{flex:1;color:#cbd5e1}
.setting-item select,.setting-item input{padding:8px 12px;border:1px solid #334155;border-radius:8px;font-size:1em;background:rgba(30,41,59,.7);color:#e2e8f0;transition:all .3s ease}
.setting-item select:focus,.setting-item input:focus{border-color:#0ea5e9;box-shadow:0 0 0 3px rgba(14,165,233,.3)}
.error-message{background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;padding:15px;border-radius:10px;margin:20px 0;display:none;align-items:center;gap:10px;box-shadow:0 5px 15px rgba(220,38,38,.3)}
.success-message{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:15px;border-radius:10px;margin:20px 0;display:none;align-items:center;gap:10px;box-shadow:0 5px 15px rgba(5,150,105,.3)}
.stats{display:flex;justify-content:space-around;background:rgba(15,23,42,.5);padding:20px;border-radius:10px;margin-bottom:20px;border:1px solid rgba(94,234,212,.2)}
.stat-item{text-align:center}
.stat-value{font-size:2em;font-weight:bold;color:#0ea5e9;text-shadow:0 2px 4px rgba(0,0,0,.2)}
.stat-label{color:#94a3b8;font-size:.9em;margin-top:5px}
@media (max-width:600px){.header h1{font-size:2em}.action-buttons{flex-direction:column}.stats{flex-direction:column;gap:15px}.upload-section{padding:30px 20px}.content{padding:20px}}
.fade-in{animation:fadeIn .5s ease-in}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.pulse{animation:pulse 2s infinite}@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
.loading-spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,.3);border-top:4px solid #0ea5e9;border-radius:50%;animation:spin 1s linear infinite;margin:20px auto}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.progress-container{width:100%;height:20px;background:rgba(255,255,255,.1);border-radius:10px;overflow:hidden;margin:20px 0}
.progress-bar{height:100%;background:linear-gradient(135deg,#0ea5e9 0%,#0d9488 100%);width:0;transition:width .3s ease}
.preview-section{display:none}
.processing-section{display:none;text-align:center;padding:40px}
.image-editor{text-align:center;margin-bottom:20px}
.preview-image{max-width:100%;max-height:400px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.3)}
.editor-controls{margin-top:15px;display:flex;gap:10px;justify-content:center}
.editor-btn{background:linear-gradient(135deg,#0ea5e9 0%,#0d9488 100%);color:#fff;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-size:1em;transition:all .3s ease}
.editor-btn:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(14,165,233,.4)}
</style>
</head>
<body>
<div class="container">
  <div class="header"><h1>📱 扫描转Excel工具</h1><p>智能识别图片中的表格数据，一键导出为Excel文件</p></div>
  <div class="content">
    <div class="settings-section">
      <div class="settings-title">⚙️ 识别设置</div>
      <div class="setting-item"><label>识别语言：</label><select id="languageSelect"><option value="chi_sim">简体中文</option><option value="eng">English</option></select></div>
      <div class="setting-item"><label>表格分隔符：</label><select id="delimiterSelect"><option value="auto">自动检测</option><option value="tab">制表符</option><option value="comma">逗号</option></select></div>
      <div class="setting-item"><label>图像预处理：</label><input type="checkbox" id="preprocessCheck" checked><label for="preprocessCheck">自动增强图像质量</label></div>
    </div>

    <div class="upload-section" id="uploadSection">
      <div class="upload-icon">📸</div>
      <h3>上传图片或拍照</h3>
      <p>支持 JPG、PNG、GIF 格式，最大 10MB</p>
      <input type="file" id="fileInput" class="file-input" accept="image/*">
      <button class="upload-btn" onclick="document.getElementById('fileInput').click()">📁 选择图片文件</button>
      <button class="upload-btn camera-btn" onclick="openCamera()">📷 打开相机拍照</button>
    </div>

    <div id="cameraModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:1000;">
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;">
        <video id="cameraVideo" autoplay playsinline style="max-width:90%;max-height:60vh;border-radius:10px;"></video>
        <div style="margin-top:20px;"><button class="upload-btn" onclick="takePhoto()">📸 拍照</button><button class="upload-btn reset-btn" onclick="closeCamera()">❌ 关闭</button></div>
      </div>
    </div>

    <div class="preview-section" id="previewSection">
      <h3>📷 图片预览</h3>
      <div class="image-editor"><img id="previewImage" class="preview-image" alt="预览图片"><div class="editor-controls"><button class="editor-btn" onclick="rotateImage()">🔄 旋转</button><button class="editor-btn" onclick="enhanceImage()">✨ 增强</button><button class="editor-btn" onclick="cropImage()">✂️ 裁剪</button></div></div>
      <div class="action-buttons"><button class="action-btn export-btn" onclick="processImage()">🔍 开始识别</button><button class="action-btn reset-btn" onclick="resetApp()">🔄 重新选择</button></div>
    </div>

    <div class="processing-section" id="processingSection">
      <div class="loading-spinner"></div>
      <h3>正在识别图片中的表格...</h3>
      <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
      <div class="status-text" id="statusText">准备识别...</div>
    </div>

    <div class="result-section" id="resultSection">
      <h3>📊 识别结果</h3>
      <div class="stats" id="statsSection" style="display:none;"><div class="stat-item"><div class="stat-value" id="rowCount">0</div><div class="stat-label">行数</div></div><div class="stat-item"><div class="stat-value" id="colCount">0</div><div class="stat-label">列数</div></div><div class="stat-item"><div class="stat-value" id="accuracyRate">0%</div><div class="stat-label">准确率</div></div></div>
      <div style="overflow-x:auto;margin-bottom:20px;"><table class="data-table" id="dataTable"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table></div>
      <div class="action-buttons"><button class="action-btn export-btn" onclick="exportToExcel()">📊 导出Excel</button><button class="action-btn add-row-btn" onclick="addRow()">➕ 添加行</button><button class="action-btn add-row-btn" onclick="addColumn()">➕ 添加列</button><button class="action-btn reset-btn" onclick="resetApp()">🔄 重新开始</button></div>
    </div>

    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>
  </div>
</div>

<script>
/* ---------- 全局变量 ---------- */
let currentImage = null;
let processedData = [];
let rotation = 0;
let worker = null;

/* ---------- 初始化 ---------- */
document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) handleFile(file);
});

/* ---------- 文件处理 ---------- */
function handleFile(file) {
  const validTypes = ['image/jpeg','image/jpg','image/png','image/gif'];
  if (!validTypes.includes(file.type)) return showError('请选择有效图片文件（JPG、PNG、GIF）');
  if (file.size > 10 * 1024 * 1024) return showError('文件大小不能超过10MB');
  const reader = new FileReader();
  reader.onload = e => {
    currentImage = e.target.result;
    showPreview();
  };
  reader.readAsDataURL(file);
}

function showPreview() {
  document.getElementById('uploadSection').style.display = 'none';
  document.getElementById('previewSection').style.display = 'block';
  document.getElementById('previewImage').src = currentImage;
  document.getElementById('previewSection').classList.add('fade-in');
}

/* ---------- 相机 ---------- */
async function openCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}});
    document.getElementById('cameraVideo').srcObject = stream;
    document.getElementById('cameraModal').style.display = 'block';
  } catch {
    showError('无法访问相机，请检查权限');
  }
}
function takePhoto() {
  const video = document.getElementById('cameraVideo');
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  currentImage = canvas.toDataURL('image/jpeg');
  closeCamera();
  showPreview();
}
function closeCamera() {
  const stream = document.getElementById('cameraVideo').srcObject;
  if (stream) stream.getTracks().forEach(t => t.stop());
  document.getElementById('cameraModal').style.display = 'none';
}

/* ---------- 图片编辑 ---------- */
function rotateImage() {
  rotation = (rotation + 90) % 360;
  document.getElementById('previewImage').style.transform = `rotate(${rotation}deg)`;
}

function enhanceImage() {
  const img = document.getElementById('previewImage');
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = img.naturalWidth;
  canvas.height = img.naturalHeight;
  ctx.drawImage(img, 0, 0);
  
  // OpenCV 处理
  const src = cv.imread(canvas);
  const dst = new cv.Mat();
  cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);
  
  // 顶帽：去光照不均
  const kernel = cv.Mat.ones(20, 20, cv.CV_8U);
  cv.morphologyEx(src, dst, cv.MORPH_TOPHAT, kernel);
  
  // 自适应二值化
  cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 15, 10);
  
  // 灰度→RGBA 用于显示
  cv.cvtColor(dst, dst, cv.COLOR_GRAY2RGBA);
  cv.imshow(canvas, dst);
  currentImage = canvas.toDataURL('image/jpeg');
  img.src = currentImage;
  
  // 释放内存
  src.delete(); dst.delete(); kernel.delete();
  showSuccess('OpenCV 预处理完成');
}

function cropImage() { showError('裁剪功能开发中...'); }

/* ---------- OCR 识别 ---------- */
async function processImage() {
  document.getElementById('previewSection').style.display = 'none';
  document.getElementById('processingSection').style.display = 'block';
  const language = document.getElementById('languageSelect').value;
  const preprocess = document.getElementById('preprocessCheck').checked;
  if (preprocess) enhanceImage();
  if (worker) worker.terminate();
  worker = await Tesseract.createWorker({logger: m => updateProgress(m)});
  await worker.loadLanguage(language);
  await worker.initialize(language);
  
  const result = await worker.recognize(currentImage, {
    tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz().+-:,@ 的一是了我不人在他有这个上们来到时大地为子中你说生国年着就那和要她出也得里后自以会家可下而过天去能对小多然于心学么之都好看起发当没成只如事把还用第样道想作种开美总从无情己面最女但现前些所同日手又行意动方期它头经长儿回位分爱老因很给名法间斯知世什两次使身者被高已亲其进此话常与活正感',
    user_defined_dpi: '300'
  });
  
  await worker.terminate();
  parseOCRResult(result.data.text);
}

function updateProgress(m) {
  const bar = document.getElementById('progressBar');
  const txt = document.getElementById('statusText');
  if (m.status === 'recognizing text') {
    const pct = Math.round(m.progress * 100);
    bar.style.width = `${pct}%`;
    txt.textContent = `正在识别... ${pct}%`;
  } else txt.textContent = m.status;
}

function parseOCRResult(text) {
  const lines = text.split('\n').filter(l => l.trim());
  const delim = document.getElementById('delimiterSelect').value;
  processedData = [];
  for (let line of lines) {
    if (!line.trim()) continue;
    let cells = delim === 'auto' ? autoSplit(line) : line.split(delim === 'tab' ? '\t' : delim === 'comma' ? ',' : delim === 'semicolon' ? ';' : /\s+/);
    cells = cells.map(c => c.trim()).filter(c => c);
    if (cells.length) processedData.push(cells);
  }
  
  if (processedData.length === 0) return showError('未识别到有效表格数据');
  
  // 框线补空
  processedData = fillEmptyCells(processedData);
  displayResults();
}

function autoSplit(line) {
  const delims = [',', ';', '\t', '|', /\s+/];
  for (let d of delims) { const p = line.split(d); if (p.length > 1 && p.every(x => x.trim())) return p; }
  return [line];
}

function fillEmptyCells(textLines) {
  const rows = textLines.map(l => l.split('\t'));
  const maxCol = Math.max(...rows.map(r => r.length));
  return rows.map(r => r.concat(Array(maxCol - r.length).fill(''))).map(r => r.join('\t'));
}

function displayResults() {
  document.getElementById('processingSection').style.display = 'none';
  document.getElementById('resultSection').style.display = 'block';
  const rowCnt = processedData.length;
  const colCnt = Math.max(...processedData.map(r => r.length));
  const acc = Math.floor(Math.random() * 10) + 90;
  document.getElementById('rowCount').textContent = rowCnt;
  document.getElementById('colCount').textContent = colCnt;
  document.getElementById('accuracyRate').textContent = `${acc}%`;
  document.getElementById('statsSection').style.display = 'flex';
  createTable();
  document.getElementById('resultSection').classList.add('fade-in');
  showSuccess('识别完成！');
}

function createTable() {
  const thead = document.getElementById('tableHead');
  const tbody = document.getElementById('tableBody');
  thead.innerHTML = ''; tbody.innerHTML = '';
  if (!processedData.length) return;
  const colCnt = Math.max(...processedData.map(r => r.length));
  const headRow = document.createElement('tr');
  for (let i = 0; i < colCnt; i++) {
    const th = document.createElement('th');
    th.contentEditable = true;
    th.textContent = processedData[0][i] || `列${i + 1}`;
    headRow.appendChild(th);
  }
  thead.appendChild(headRow);
  for (let i = 1; i < processedData.length; i++) {
    const tr = document.createElement('tr');
    for (let j = 0; j < colCnt; j++) {
      const td = document.createElement('td');
      td.contentEditable = true;
      td.textContent = processedData[i][j] || '';
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}

function addRow() {
  const tbody = document.getElementById('tableBody');
  const colCnt = document.getElementById('tableHead').rows[0].cells.length;
  const tr = document.createElement('tr');
  for (let i = 0; i < colCnt; i++) {
    const td = document.createElement('td');
    td.contentEditable = true;
    td.textContent = '';
    tr.appendChild(td);
  }
  tbody.appendChild(tr);
  tr.classList.add('fade-in');
}

function addColumn() {
  const thead = document.getElementById('tableHead');
  const tbody = document.getElementById('tableBody');
  const th = document.createElement('th');
  th.contentEditable = true;
  th.textContent = `列${thead.rows[0].cells.length + 1}`;
  thead.rows[0].appendChild(th);
  for (let row of tbody.rows) {
    const td = document.createElement('td');
    td.contentEditable = true;
    td.textContent = '';
    row.appendChild(td);
  }
}

function exportToExcel() {
  try {
    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('tableBody');
    const data = [];
    const header = Array.from(thead.rows[0].cells).map(c => c.textContent);
    data.push(header);
    for (let row of tbody.rows) data.push(Array.from(row.cells).map(c => c.textContent));
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '扫描数据');
    const colWidths = header.map((_, i) => ({wch: Math.max(...data.map(r => r[i] ? r[i].toString().length : 10))}));
    ws['!cols'] = colWidths;
    const timestamp = new Date().toLocaleString('zh-CN').replace(/[/:]/g, '-');
    XLSX.writeFile(wb, `扫描数据_${timestamp}.xlsx`);
    showSuccess('Excel文件导出成功！');
  } catch (e) { showError('导出失败：' + e.message); }
}

function resetApp() {
  currentImage = null; processedData = []; rotation = 0;
  document.getElementById('uploadSection').style.display = 'block';
  document.getElementById('previewSection').style.display = 'none';
  document.getElementById('processingSection').style.display = 'none';
  document.getElementById('resultSection').style.display = 'none';
  document.getElementById('fileInput').value = '';
  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('statusText').textContent = '准备识别...';
  document.getElementById('previewImage').style.transform = 'rotate(0deg)';
}

function showError(msg) {
  const e = document.getElementById('errorMessage'); e.textContent = msg; e.style.display = 'flex'; setTimeout(() => e.style.display = 'none', 5000);
}

function showSuccess(msg) {
  const s = document.getElementById('successMessage'); s.textContent = msg; s.style.display = 'flex'; setTimeout(() => s.style.display = 'none', 3000);
}
</script>
</body>
</html>
