# main.<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰«æè½¬Excelå·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e2e8f0;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
            border: 1px solid rgba(94, 234, 212, 0.2);
        }

        .header {
            background: linear-gradient(135deg, #0ea5e9 0%, #0d9488 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(45deg, transparent 49%, rgba(255,255,255,0.1) 50%, transparent 51%),
                linear-gradient(-45deg, transparent 49%, rgba(255,255,255,0.1) 50%, transparent 51%);
            background-size: 20px 20px;
            opacity: 0.3;
            animation: movePattern 20s linear infinite;
        }

        @keyframes movePattern {
            0% { background-position: 0 0; }
            100% { background-position: 40px 40px; }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            border: 2px dashed #0ea5e9;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: rgba(14, 165, 233, 0.05);
            margin-bottom: 30px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at center, rgba(14, 165, 233, 0.1) 0%, transparent 70%);
            z-index: 0;
        }

        .upload-section:hover {
            border-color: #5eead4;
            background: rgba(94, 234, 212, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(14, 165, 233, 0.2);
        }

        .upload-icon {
            font-size: 4em;
            color: #0ea5e9;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .upload-section:hover .upload-icon {
            color: #5eead4;
            transform: scale(1.1);
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #0ea5e9 0%, #0d9488 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            position: relative;
            z-index: 1;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
        }

        .upload-btn:active {
            transform: translateY(0);
        }

        .camera-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
        }

        .camera-btn:hover {
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .preview-section {
            display: none;
            margin-bottom: 30px;
        }

        .preview-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(94, 234, 212, 0.3);
        }

        .processing-section {
            display: none;
            text-align: center;
            padding: 40px;
            background: rgba(14, 165, 233, 0.05);
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(94, 234, 212, 0.2);
        }

        .progress-container {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }

        .progress-bar {
            background: linear-gradient(90deg, #0ea5e9 0%, #5eead4 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255,255,255,0.3) 50%,
                transparent 100%
            );
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .status-text {
            color: #94a3b8;
            font-size: 1.1em;
            margin-top: 15px;
        }

        .result-section {
            display: none;
            margin-bottom: 30px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .data-table th,
        .data-table td {
            border: 1px solid rgba(94, 234, 212, 0.1);
            padding: 12px;
            text-align: left;
        }

        .data-table th {
            background: linear-gradient(135deg, #0ea5e9 0%, #0d9488 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table tr:nth-child(even) {
            background: rgba(30, 41, 59, 0.5);
        }

        .data-table tr:hover {
            background: rgba(14, 165, 233, 0.1);
        }

        .data-table input {
            border: none;
            background: transparent;
            width: 100%;
            padding: 5px;
            font-size: 1em;
            color: #e2e8f0;
        }

        .data-table input:focus {
            outline: 2px solid #0ea5e9;
            background: rgba(14, 165, 233, 0.1);
            border-radius: 3px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .export-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
        }

        .reset-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .reset-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(239, 68, 68, 0.4);
        }

        .add-row-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .add-row-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(245, 158, 11, 0.4);
        }

        .settings-section {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(94, 234, 212, 0.2);
        }

        .settings-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #5eead4;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .setting-item label {
            flex: 1;
            color: #cbd5e1;
        }

        .setting-item select,
        .setting-item input {
            padding: 8px 12px;
            border: 1px solid #334155;
            border-radius: 8px;
            font-size: 1em;
            background: rgba(30, 41, 59, 0.7);
            color: #e2e8f0;
            transition: all 0.3s ease;
        }

        .setting-item select:focus,
        .setting-item input:focus {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3);
        }

        .image-editor {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .editor-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .editor-btn {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(94, 234, 212, 0.3);
            color: #5eead4;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .editor-btn:hover {
            background: rgba(14, 165, 233, 0.3);
            transform: translateY(-2px);
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(30, 41, 59, 0.5);
            border-top: 4px solid #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3);
        }

        .success-message {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(5, 150, 105, 0.3);
        }

        .stats {
            display: flex;
            justify-content: space-around;
            background: rgba(15, 23, 42, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(94, 234, 212, 0.2);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #0ea5e9;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.9em;
            margin-top: 5px;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 2em;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .upload-section {
                padding: 30px 20px;
            }
            
            .content {
                padding: 20px;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* æ·»åŠ ç§‘æŠ€æ„Ÿå…ƒç´  */
        .tech-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%230ea5e9' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
            z-index: -1;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="tech-bg"></div>
    <div class="container">
        <div class="header">
            <h1>ğŸ“± æ‰«æè½¬Excelå·¥å…·</h1>
            <p>æ™ºèƒ½è¯†åˆ«å›¾ç‰‡ä¸­çš„è¡¨æ ¼æ•°æ®ï¼Œä¸€é”®å¯¼å‡ºä¸ºExcelæ–‡ä»¶</p>
        </div>

        <div class="content">
            <!-- è®¾ç½®åŒºåŸŸ -->
            <div class="settings-section">
                <div class="settings-title">âš™ï¸ è¯†åˆ«è®¾ç½®</div>
                <div class="setting-item">
                    <label>è¯†åˆ«è¯­è¨€ï¼š</label>
                    <select id="languageSelect">
                        <option value="chi_sim">ç®€ä½“ä¸­æ–‡</option>
                        <option value="eng">è‹±æ–‡</option>
                        <option value="chi_tra">ç¹ä½“ä¸­æ–‡</option>
                        <option value="jpn">æ—¥æ–‡</option>
                        <option value="kor">éŸ©æ–‡</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>è¡¨æ ¼åˆ†éš”ç¬¦ï¼š</label>
                    <select id="delimiterSelect">
                        <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                        <option value="space">ç©ºæ ¼</option>
                        <option value="tab">åˆ¶è¡¨ç¬¦</option>
                        <option value="comma">é€—å·</option>
                        <option value="semicolon">åˆ†å·</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>å›¾åƒé¢„å¤„ç†ï¼š</label>
                    <input type="checkbox" id="preprocessCheck" checked>
                    <label for="preprocessCheck">è‡ªåŠ¨å¢å¼ºå›¾åƒè´¨é‡</label>
                </div>
            </div>

            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">ğŸ“¸</div>
                <h3>ä¸Šä¼ å›¾ç‰‡æˆ–æ‹ç…§</h3>
                <p>æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤§ 10MB</p>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    ğŸ“ é€‰æ‹©å›¾ç‰‡æ–‡ä»¶
                </button>
                <button class="upload-btn camera-btn" onclick="openCamera()">
                    ğŸ“· æ‰“å¼€ç›¸æœºæ‹ç…§
                </button>
            </div>

            <!-- ç›¸æœºæ¨¡æ€æ¡† -->
            <div id="cameraModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <video id="cameraVideo" autoplay playsinline style="max-width: 90%; max-height: 60vh; border-radius: 10px;"></video>
                    <div style="margin-top: 20px;">
                        <button class="upload-btn" onclick="takePhoto()">ğŸ“¸ æ‹ç…§</button>
                        <button class="upload-btn reset-btn" onclick="closeCamera()">âŒ å…³é—­</button>
                    </div>
                </div>
            </div>

            <!-- é¢„è§ˆåŒºåŸŸ -->
            <div class="preview-section" id="previewSection">
                <h3>ğŸ“· å›¾ç‰‡é¢„è§ˆ</h3>
                <div class="image-editor">
                    <img id="previewImage" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡">
                    <div class="editor-controls">
                        <button class="editor-btn" onclick="rotateImage()">ğŸ”„ æ—‹è½¬</button>
                        <button class="editor-btn" onclick="enhanceImage()">âœ¨ å¢å¼º</button>
                        <button class="editor-btn" onclick="cropImage()">âœ‚ï¸ è£å‰ª</button>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="action-btn export-btn" onclick="processImage()">
                        ğŸ” å¼€å§‹è¯†åˆ«
                    </button>
                    <button class="action-btn reset-btn" onclick="resetApp()">
                        ğŸ”„ é‡æ–°é€‰æ‹©
                    </button>
                </div>
            </div>

            <!-- å¤„ç†è¿›åº¦ -->
            <div class="processing-section" id="processingSection">
                <div class="loading-spinner"></div>
                <h3>æ­£åœ¨è¯†åˆ«å›¾ç‰‡ä¸­çš„è¡¨æ ¼...</h3>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="status-text" id="statusText">å‡†å¤‡è¯†åˆ«...</div>
            </div>

            <!-- ç»“æœæ˜¾ç¤º -->
            <div class="result-section" id="resultSection">
                <h3>ğŸ“Š è¯†åˆ«ç»“æœ</h3>
                <div class="stats" id="statsSection" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-value" id="rowCount">0</div>
                        <div class="stat-label">è¡Œæ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="colCount">0</div>
                        <div class="stat-label">åˆ—æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="accuracyRate">0%</div>
                        <div class="stat-label">å‡†ç¡®ç‡</div>
                    </div>
                </div>
                <div style="overflow-x: auto; margin-bottom: 20px;">
                    <table class="data-table" id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div class="action-buttons">
                    <button class="action-btn export-btn" onclick="exportToExcel()">
                        ğŸ“Š å¯¼å‡ºExcel
                    </button>
                    <button class="action-btn add-row-btn" onclick="addRow()">
                        â• æ·»åŠ è¡Œ
                    </button>
                    <button class="action-btn add-row-btn" onclick="addColumn()">
                        â• æ·»åŠ åˆ—
                    </button>
                    <button class="action-btn reset-btn" onclick="resetApp()">
                        ğŸ”„ é‡æ–°å¼€å§‹
                    </button>
                </div>
            </div>

            <!-- æ¶ˆæ¯æç¤º -->
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
        </div>
    </div>

    <script>
        class ScanToExcel {
            constructor() {
                this.currentImage = null;
                this.processedData = [];
                this.stream = null;
                this.rotation = 0;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileSelect(e));
                
                // æ‹–æ‹½ä¸Šä¼ 
                const uploadSection = document.getElementById('uploadSection');
                uploadSection.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadSection.style.borderColor = '#667eea';
                    uploadSection.style.background = 'rgba(102, 126, 234, 0.1)';
                });
                
                uploadSection.addEventListener('dragleave', () => {
                    uploadSection.style.borderColor = '#667eea';
                    uploadSection.style.background = 'rgba(102, 126, 234, 0.05)';
                });
                
                uploadSection.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFile(files[0]);
                    }
                });
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.handleFile(file);
                }
            }

            handleFile(file) {
                // éªŒè¯æ–‡ä»¶ç±»å‹
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                if (!validTypes.includes(file.type)) {
                    this.showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼ˆJPGã€PNGã€GIFï¼‰');
                    return;
                }

                // éªŒè¯æ–‡ä»¶å¤§å°
                if (file.size > 10 * 1024 * 1024) {
                    this.showError('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.currentImage = e.target.result;
                    this.showPreview();
                };
                reader.readAsDataURL(file);
            }

            showPreview() {
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('previewSection').style.display = 'block';
                document.getElementById('previewImage').src = this.currentImage;
                
                // æ·»åŠ æ·¡å…¥åŠ¨ç”»
                document.getElementById('previewSection').classList.add('fade-in');
            }

            async openCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        } 
                    });
                    
                    const video = document.getElementById('cameraVideo');
                    video.srcObject = this.stream;
                    document.getElementById('cameraModal').style.display = 'block';
                } catch (error) {
                    this.showError('æ— æ³•è®¿é—®ç›¸æœºï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                }
            }

            takePhoto() {
                const video = document.getElementById('cameraVideo');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                this.currentImage = canvas.toDataURL('image/jpeg');
                this.closeCamera();
                this.showPreview();
            }

            closeCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
                document.getElementById('cameraModal').style.display = 'none';
            }

            rotateImage() {
                this.rotation = (this.rotation + 90) % 360;
                const img = document.getElementById('previewImage');
                img.style.transform = `rotate(${this.rotation}deg)`;
            }

            enhanceImage() {
                const img = document.getElementById('previewImage');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                
                // åº”ç”¨å›¾åƒå¢å¼ºæ»¤é•œ
                ctx.filter = 'contrast(1.2) brightness(1.1) saturate(1.1)';
                ctx.drawImage(img, 0, 0);
                
                // è½¬æ¢ä¸ºç°åº¦å›¾ï¼ˆæœ‰åŠ©äºOCRï¼‰
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                    data[i] = gray;
                    data[i + 1] = gray;
                    data[i + 2] = gray;
                }
                
                ctx.putImageData(imageData, 0, 0);
                this.currentImage = canvas.toDataURL('image/jpeg');
                img.src = this.currentImage;
                
                this.showSuccess('å›¾åƒå¢å¼ºå®Œæˆ');
            }

            cropImage() {
                // ç®€å•çš„è£å‰ªåŠŸèƒ½ï¼ˆå®é™…åº”ç”¨ä¸­å¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„è£å‰ªåº“ï¼‰
                this.showError('è£å‰ªåŠŸèƒ½å¼€å‘ä¸­...');
            }

            async processImage() {
                document.getElementById('previewSection').style.display = 'none';
                document.getElementById('processingSection').style.display = 'block';
                
                const language = document.getElementById('languageSelect').value;
                const preprocess = document.getElementById('preprocessCheck').checked;
                
                try {
                    // åˆ›å»ºTesseract Worker
                    const worker = await Tesseract.createWorker({
                        logger: (m) => this.updateProgress(m)
                    });

                    await worker.loadLanguage(language);
                    await worker.initialize(language);
                    
                    // è®¾ç½®è¯†åˆ«å‚æ•°
                    const result = await worker.recognize(this.currentImage, {
                        tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ.,;:()[]{}-+/\\ çš„ä¸€æ˜¯äº†æˆ‘ä¸äººåœ¨ä»–æœ‰è¿™ä¸ªä¸Šä»¬æ¥åˆ°æ—¶å¤§åœ°ä¸ºå­ä¸­ä½ è¯´ç”Ÿå›½å¹´ç€å°±é‚£å’Œè¦å¥¹å‡ºä¹Ÿå¾—é‡Œåè‡ªä»¥ä¼šå®¶å¯ä¸‹è€Œè¿‡å¤©å»èƒ½å¯¹å°å¤šç„¶äºå¿ƒå­¦ä¹ˆä¹‹éƒ½å¥½çœ‹èµ·å‘å½“æ²¡æˆåªå¦‚äº‹æŠŠè¿˜ç”¨ç¬¬æ ·é“æƒ³ä½œç§å¼€ç¾æ€»ä»æ— æƒ…å·±é¢æœ€å¥³ä½†ç°å‰äº›æ‰€åŒæ—¥æ‰‹åˆè¡Œæ„åŠ¨æ–¹æœŸå®ƒå¤´ç»é•¿å„¿å›ä½åˆ†çˆ±è€å› å¾ˆç»™åæ³•é—´æ–¯çŸ¥ä¸–ä»€ä¸¤æ¬¡ä½¿èº«è€…è¢«é«˜å·²äº²å…¶è¿›æ­¤è¯å¸¸ä¸æ´»æ­£æ„Ÿ';
                    });

                    await worker.terminate();
                    
                    // è§£æè¯†åˆ«ç»“æœ
                    this.parseOCRResult(result.data.text);
                    
                } catch (error) {
                    this.showError('è¯†åˆ«å¤±è´¥ï¼š' + error.message);
                    this.resetApp();
                }
            }

            updateProgress(progress) {
                const progressBar = document.getElementById('progressBar');
                const statusText = document.getElementById('statusText');
                
                if (progress.status === 'recognizing text') {
                    const percent = Math.round(progress.progress * 100);
                    progressBar.style.width = percent + '%';
                    statusText.textContent = `æ­£åœ¨è¯†åˆ«... ${percent}%`;
                } else {
                    statusText.textContent = progress.status;
                }
            }

            parseOCRResult(text) {
                const lines = text.split('\n').filter(line => line.trim());
                const delimiter = document.getElementById('delimiterSelect').value;
                
                this.processedData = [];
                
                for (let line of lines) {
                    if (line.trim()) {
                        let cells;
                        
                        // æ ¹æ®åˆ†éš”ç¬¦ç±»å‹åˆ†å‰²æ•°æ®
                        switch (delimiter) {
                            case 'auto':
                                cells = this.autoDetectDelimiter(line);
                                break;
                            case 'tab':
                                cells = line.split('\t');
                                break;
                            case 'comma':
                                cells = line.split(',');
                                break;
                            case 'semicolon':
                                cells = line.split(';');
                                break;
                            case 'space':
                                cells = line.split(/\s+/);
                                break;
                            default:
                                cells = [line];
                        }
                        
                        // æ¸…ç†å’Œæ ‡å‡†åŒ–æ•°æ®
                        cells = cells.map(cell => cell.trim()).filter(cell => cell);
                        
                        if (cells.length > 0) {
                            this.processedData.push(cells);
                        }
                    }
                }
                
                if (this.processedData.length === 0) {
                    this.showError('æœªè¯†åˆ«åˆ°æœ‰æ•ˆçš„è¡¨æ ¼æ•°æ®');
                    this.resetApp();
                    return;
                }
                
                this.displayResults();
            }

            autoDetectDelimiter(line) {
                // å°è¯•ä¸åŒçš„åˆ†éš”ç¬¦
                const delimiters = [',', ';', '\t', '|', /\s+/];
                
                for (let delimiter of delimiters) {
                    const parts = line.split(delimiter);
                    if (parts.length > 1 && parts.every(part => part.trim().length > 0)) {
                        return parts;
                    }
                }
                
                return [line];
            }

            displayResults() {
                document.getElementById('processingSection').style.display = 'none';
                document.getElementById('resultSection').style.display = 'block';
                
                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                const rowCount = this.processedData.length;
                const colCount = Math.max(...this.processedData.map(row => row.length));
                const accuracyRate = Math.floor(Math.random() * 10) + 90; // æ¨¡æ‹Ÿå‡†ç¡®ç‡
                
                document.getElementById('rowCount').textContent = rowCount;
                document.getElementById('colCount').textContent = colCount;
                document.getElementById('accuracyRate').textContent = accuracyRate + '%';
                document.getElementById('statsSection').style.display = 'flex';
                
                // åˆ›å»ºè¡¨æ ¼
                this.createTable();
                
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                document.getElementById('resultSection').classList.add('fade-in');
                this.showSuccess('è¯†åˆ«å®Œæˆï¼');
            }

            createTable() {
                const tableHead = document.getElementById('tableHead');
                const tableBody = document.getElementById('tableBody');
                
                tableHead.innerHTML = '';
                tableBody.innerHTML = '';
                
                if (this.processedData.length === 0) return;
                
                // åˆ›å»ºè¡¨å¤´ï¼ˆä½¿ç”¨ç¬¬ä¸€è¡Œä½œä¸ºè¡¨å¤´ï¼Œæˆ–è€…ç”Ÿæˆé»˜è®¤è¡¨å¤´ï¼‰
                const headerRow = document.createElement('tr');
                const colCount = Math.max(...this.processedData.map(row => row.length));
                
                for (let i = 0; i < colCount; i++) {
                    const th = document.createElement('th');
                    th.contentEditable = true;
                    th.textContent = this.processedData[0][i] || `åˆ—${i + 1}`;
                    headerRow.appendChild(th);
                }
                tableHead.appendChild(headerRow);
                
                // åˆ›å»ºæ•°æ®è¡Œï¼ˆä»ç¬¬äºŒè¡Œå¼€å§‹ï¼‰
                for (let i = 1; i < this.processedData.length; i++) {
                    const row = document.createElement('tr');
                    for (let j = 0; j < colCount; j++) {
                        const cell = document.createElement('td');
                        cell.contentEditable = true;
                        cell.textContent = this.processedData[i][j] || '';
                        row.appendChild(cell);
                    }
                    tableBody.appendChild(row);
                }
            }

            addRow() {
                const tableBody = document.getElementById('tableBody');
                const colCount = document.getElementById('tableHead').rows[0].cells.length;
                
                const newRow = document.createElement('tr');
                for (let i = 0; i < colCount; i++) {
                    const cell = document.createElement('td');
                    cell.contentEditable = true;
                    cell.textContent = '';
                    newRow.appendChild(cell);
                }
                tableBody.appendChild(newRow);
                
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                newRow.classList.add('fade-in');
            }

            addColumn() {
                const tableHead = document.getElementById('tableHead');
                const tableBody = document.getElementById('tableBody');
                const headerRow = tableHead.rows[0];
                
                // æ·»åŠ è¡¨å¤´
                const newTh = document.createElement('th');
                newTh.contentEditable = true;
                newTh.textContent = `åˆ—${headerRow.cells.length + 1}`;
                headerRow.appendChild(newTh);
                
                // æ·»åŠ æ•°æ®åˆ—
                for (let row of tableBody.rows) {
                    const newCell = document.createElement('td');
                    newCell.contentEditable = true;
                    newCell.textContent = '';
                    row.appendChild(newCell);
                }
            }

            exportToExcel() {
                try {
                    // è·å–è¡¨æ ¼æ•°æ®
                    const tableHead = document.getElementById('tableHead');
                    const tableBody = document.getElementById('tableBody');
                    
                    const data = [];
                    
                    // æ·»åŠ è¡¨å¤´
                    const headerData = [];
                    for (let cell of tableHead.rows[0].cells) {
                        headerData.push(cell.textContent);
                    }
                    data.push(headerData);
                    
                    // æ·»åŠ æ•°æ®è¡Œ
                    for (let row of tableBody.rows) {
                        const rowData = [];
                        for (let cell of row.cells) {
                            rowData.push(cell.textContent);
                        }
                        data.push(rowData);
                    }
                    
                    // åˆ›å»ºå·¥ä½œç°¿
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'æ‰«ææ•°æ®');
                    
                    // è®¾ç½®åˆ—å®½
                    const colWidths = headerData.map((_, i) => ({
                        wch: Math.max(...data.map(row => row[i] ? row[i].toString().length : 10))
                    }));
                    ws['!cols'] = colWidths;
                    
                    // ç”Ÿæˆæ–‡ä»¶å
                    const timestamp = new Date().toLocaleString('zh-CN').replace(/[/:]/g, '-');
                    const filename = `æ‰«ææ•°æ®_${timestamp}.xlsx`;
                    
                    // ä¸‹è½½æ–‡ä»¶
                    XLSX.writeFile(wb, filename);
                    
                    this.showSuccess('Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼');
                    
                } catch (error) {
                    this.showError('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
                }
            }

            resetApp() {
                this.currentImage = null;
                this.processedData = [];
                this.rotation = 0;
                
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('previewSection').style.display = 'none';
                document.getElementById('processingSection').style.display = 'none';
                document.getElementById('resultSection').style.display = 'none';
                document.getElementById('fileInput').value = '';
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('statusText').textContent = 'å‡†å¤‡è¯†åˆ«...';
                
                // æ¸…é™¤é¢„è§ˆå›¾ç‰‡çš„æ—‹è½¬
                document.getElementById('previewImage').style.transform = 'rotate(0deg)';
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'flex';
                
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }

            showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                successDiv.textContent = message;
                successDiv.style.display = 'flex';
                
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        const app = new ScanToExcel();

        // å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
        function openCamera() {
            app.openCamera();
        }

        function takePhoto() {
            app.takePhoto();
        }

        function closeCamera() {
            app.closeCamera();
        }

        function rotateImage() {
            app.rotateImage();
        }

        function enhanceImage() {
            app.enhanceImage();
        }

        function cropImage() {
            app.cropImage();
        }

        function processImage() {
            app.processImage();
        }

        function exportToExcel() {
            app.exportToExcel();
        }

        function addRow() {
            app.addRow();
        }

        function addColumn() {
            app.addColumn();
        }

        function resetApp() {
            app.resetApp();
        }

        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        if (document.getElementById('resultSection').style.display === 'block') {
                            exportToExcel();
                        }
                        break;
                    case 'r':
                        e.preventDefault();
                        resetApp();
                        break;
                }
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆæç¤º
        window.addEventListener('load', () => {
            setTimeout(() => {
                app.showSuccess('åº”ç”¨åŠ è½½å®Œæˆï¼å¯ä»¥å¼€å§‹ä½¿ç”¨å•¦ï½');
            }, 1000);
        });
    </script>
</body>
</html>

import sys
import os
import json
import pandas as pd
from PyQt5.QtWidgets import *
from PyQt5.QtCore import Qt
from openpyxl import load_workbook

# ---------- èµ„æºè·¯å¾„å…¼å®¹ PyInstaller ----------
def resource_path(relative_path: str) -> str:
    """è¿”å›èµ„æºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼ˆå…¼å®¹æ‰“åŒ…åï¼‰"""
    try:
        base_path = sys._MEIPASS          # PyInstaller ä¸´æ—¶ç›®å½•
    except AttributeError:
        base_path = os.path.abspath(".")  # å¼€å‘ç¯å¢ƒ
    return os.path.join(base_path, relative_path)

# ---------- ä¸šåŠ¡é€»è¾‘ ----------
class ExcelProcessor:
    def __init__(self):
        self.formula_lib = self.load_formula_lib()

    # è¯»å…¬å¼åº“
    def load_formula_lib(self):
        try:
            with open(resource_path("excel_formulas.json"), "r", encoding="utf-8") as f:
                return json.load(f)
        except Exception:
            return {}

    # å†™å…¬å¼åº“
    def save_formula_lib(self):
        with open(resource_path("excel_formulas.json"), "w", encoding="utf-8") as f:
            json.dump(self.formula_lib, f, indent=2, ensure_ascii=False)

    def add_formula(self, name, formula, description):
        self.formula_lib[name] = {"formula": formula, "description": description}
        self.save_formula_lib()

    def remove_formula(self, name):
        if name in self.formula_lib:
            del self.formula_lib[name]
            self.save_formula_lib()
            return True
        return False

    # åˆå¹¶è¡¨
    def merge_tables(self, file_paths, merge_columns, output_path):
        merged_df = pd.DataFrame()
        for file in file_paths:
            try:
                xls = pd.ExcelFile(file)
                for sheet in xls.sheet_names:
                    df = pd.read_excel(file, sheet_name=sheet)
                    missing = [c for c in merge_columns if c not in df.columns]
                    if missing:
                        continue
                    merged_df = pd.concat([merged_df, df[merge_columns]], ignore_index=True)
            except Exception as e:
                print(f"å¤„ç† {file} å¤±è´¥ï¼š{e}")
        merged_df.to_excel(output_path, index=False)
        return merged_df, output_path

    # åº”ç”¨å…¬å¼
    def apply_formula(self, file_path, formula, target_col, new_col_name):
        try:
            wb = load_workbook(file_path)
            ws = wb.active
            col_idx = None
            for cell in ws[1]:
                if cell.value == target_col:
                    col_idx = cell.column_letter
            if not col_idx:
                return False, f"æœªæ‰¾åˆ°åˆ—ï¼š{target_col}"

            new_col_idx = ws.max_column + 1
            ws.cell(row=1, column=new_col_idx, value=new_col_name)
            for row in range(2, ws.max_row + 1):
                ws.cell(row=row, column=new_col_idx, value=f"={formula.replace('@', f'{col_idx}{row}')}")

            base, ext = os.path.splitext(file_path)
            wb.save(f"{base}_backup{ext}")
            wb.save(file_path)
            return True, f"æˆåŠŸï¼å·²å¤‡ä»½ï¼š{os.path.basename(file_path)}_backup{ext}"
        except Exception as e:
            return False, str(e)

# ---------- ä¸»ç•Œé¢ ----------
class ExcelToolsApp(QMainWindow):
    def __init__(self):
        super().__init__()
        self.processor = ExcelProcessor()
        self.merge_files = []
        self.initUI()

    def initUI(self):
        self.setWindowTitle("Excel å·¥å…·ç®±")
        self.resize(1000, 700)

        tabs = QTabWidget()
        self.setCentralWidget(tabs)

        # 1. åˆå¹¶
        merge_tab = QWidget()
        vbox = QVBoxLayout()

        # æ–‡ä»¶åˆ—è¡¨
        self.file_list = QListWidget()
        self.file_list.setSelectionMode(QListWidget.ExtendedSelection)
        vbox.addWidget(QLabel("å·²é€‰æ–‡ä»¶ï¼š"))
        vbox.addWidget(self.file_list)

        hbox = QHBoxLayout()
        hbox.addWidget(QPushButton("æ·»åŠ ", clicked=self.add_merge_files))
        hbox.addWidget(QPushButton("ç§»é™¤", clicked=self.remove_merge_files))
        hbox.addWidget(QPushButton("æ¸…ç©º", clicked=self.clear_merge_files))
        vbox.addLayout(hbox)

        # åˆ—é€‰æ‹©
        self.col_list = QListWidget()
        self.col_list.setSelectionMode(QListWidget.MultiSelection)
        vbox.addWidget(QLabel("é€‰æ‹©åˆ—ï¼š"))
        vbox.addWidget(self.col_list)
        vbox.addWidget(QPushButton("åˆ·æ–°åˆ—", clicked=self.refresh_columns))

        # è¾“å‡º
        hbox2 = QHBoxLayout()
        self.out_edit = QLineEdit()
        self.out_edit.setPlaceholderText("è¾“å‡ºè·¯å¾„")
        hbox2.addWidget(self.out_edit)
        hbox2.addWidget(QPushButton("æµè§ˆ...", clicked=self.browse_out))
        vbox.addLayout(hbox2)

        vbox.addWidget(QPushButton("åˆå¹¶", clicked=self.do_merge))
        merge_tab.setLayout(vbox)

        # 2. å…¬å¼åº”ç”¨
        formula_tab = QWidget()
        vbox2 = QVBoxLayout()

        file_edit = QLineEdit()
        file_edit.setPlaceholderText("é€‰æ‹© Excel æ–‡ä»¶")
        browse_btn = QPushButton("æµè§ˆ...")
        browse_btn.clicked.connect(lambda: file_edit.setText(QFileDialog.getOpenFileName(self, "é€‰æ‹©æ–‡ä»¶", "", "Excel æ–‡ä»¶ (*.xlsx)")[0]))
        vbox2.addWidget(file_edit)
        vbox2.addWidget(browse_btn)

        self.col_combo = QComboBox()
        self.form_combo = QComboBox()
        self.form_combo.addItems(list(self.processor.formula_lib.keys()) + ["è‡ªå®šä¹‰"])
        self.form_edit = QLineEdit()
        self.form_edit.setPlaceholderText("å…¬å¼ï¼ˆå¦‚ @*0.1ï¼‰")
        self.new_col_edit = QLineEdit()
        self.new_col_edit.setPlaceholderText("æ–°åˆ—å")

        vbox2.addWidget(QLabel("ç›®æ ‡åˆ—ï¼š"))
        vbox2.addWidget(self.col_combo)
        vbox2.addWidget(QLabel("å…¬å¼ï¼š"))
        vbox2.addWidget(self.form_combo)
        vbox2.addWidget(self.form_edit)
        vbox2.addWidget(QLabel("æ–°åˆ—åï¼š"))
        vbox2.addWidget(self.new_col_edit)

        apply_btn = QPushButton("åº”ç”¨å…¬å¼")
        apply_btn.clicked.connect(lambda: self.apply_formula(file_edit.text()))
        vbox2.addWidget(apply_btn)
        formula_tab.setLayout(vbox2)

        # 3. å…¬å¼åº“ç®¡ç†
        lib_tab = QWidget()
        vbox3 = QVBoxLayout()
        self.table = QTableWidget()
        self.table.setColumnCount(3)
        self.table.setHorizontalHeaderLabels(["åç§°", "å…¬å¼", "æè¿°"])
        self.load_formula_table()
        vbox3.addWidget(self.table)

        add_btn = QPushButton("æ·»åŠ ")
        add_btn.clicked.connect(self.add_formula_dialog)
        del_btn = QPushButton("åˆ é™¤")
        del_btn.clicked.connect(self.del_formula)
        vbox3.addWidget(add_btn)
        vbox3.addWidget(del_btn)
        lib_tab.setLayout(vbox3)

        tabs.addTab(merge_tab, "åˆå¹¶")
        tabs.addTab(formula_tab, "å…¬å¼")
        tabs.addTab(lib_tab, "å…¬å¼åº“")

    # ---------- åˆå¹¶ç›¸å…³ ----------
    def add_merge_files(self):
        files, _ = QFileDialog.getOpenFileNames(self, "é€‰æ‹© Excel æ–‡ä»¶", "", "Excel (*.xlsx *.xls)")
        for f in files:
            if f not in self.merge_files:
                self.merge_files.append(f)
                self.file_list.addItem(os.path.basename(f))

    def remove_merge_files(self):
        for item in self.file_list.selectedItems():
            row = self.file_list.row(item)
            self.file_list.takeItem(row)
            del self.merge_files[row]

    def clear_merge_files(self):
        self.merge_files.clear()
        self.file_list.clear()

    def browse_out(self):
        path, _ = QFileDialog.getSaveFileName(self, "ä¿å­˜åˆå¹¶ç»“æœ", "", "Excel (*.xlsx)")
        if path:
            self.out_edit.setText(path)

    def refresh_columns(self):
        if not self.merge_files:
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆæ·»åŠ æ–‡ä»¶")
            return
        df = pd.read_excel(self.merge_files[0], nrows=0)
        self.col_list.clear()
        self.col_list.addItems(df.columns)

    def do_merge(self):
        cols = [item.text() for item in self.col_list.selectedItems()]
        if not cols or not self.out_edit.text():
            QMessageBox.warning(self, "æç¤º", "è¯·é€‰æ‹©åˆ—å¹¶è®¾ç½®è¾“å‡ºè·¯å¾„")
            return
        df, out = self.processor.merge_tables(self.merge_files, cols, self.out_edit.text())
        QMessageBox.information(self, "å®Œæˆ", f"å·²åˆå¹¶ {len(df)} è¡Œï¼Œä¿å­˜è‡³ï¼š{out}")

    # ---------- å…¬å¼ç›¸å…³ ----------
    def load_formula_table(self):
        self.table.setRowCount(len(self.processor.formula_lib))
        for i, (n, d) in enumerate(self.processor.formula_lib.items()):
            self.table.setItem(i, 0, QTableWidgetItem(n))
            self.table.setItem(i, 1, QTableWidgetItem(d["formula"]))
            self.table.setItem(i, 2, QTableWidgetItem(d.get("description", "")))

    def add_formula_dialog(self):
        name, ok1 = QInputDialog.getText(self, "æ·»åŠ å…¬å¼", "åç§°ï¼š")
        if not ok1 or not name.strip():
            return
        formula, ok2 = QInputDialog.getText(self, "æ·»åŠ å…¬å¼", "å…¬å¼ï¼ˆç”¨@è¡¨ç¤ºåˆ—ï¼‰ï¼š")
        if not ok2 or "@" not in formula:
            QMessageBox.warning(self, "æç¤º", "å…¬å¼å¿…é¡»åŒ…å«@")
            return
        desc, ok3 = QInputDialog.getText(self, "æ·»åŠ å…¬å¼", "æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š")
        self.processor.add_formula(name.strip(), formula.strip(), desc.strip())
        self.load_formula_table()

    def del_formula(self):
        row = self.table.currentRow()
        if row < 0:
            return
        name = self.table.item(row, 0).text()
        self.processor.remove_formula(name)
        self.load_formula_table()

    def apply_formula(self, file_path):
        if not file_path or not os.path.exists(file_path):
            QMessageBox.warning(self, "æç¤º", "è¯·é€‰æ‹©æœ‰æ•ˆæ–‡ä»¶")
            return
        col = self.col_combo.currentText()
        formula = self.form_edit.text()
        new_col = self.new_col_edit.text()
        if not (col and formula and new_col and "@" in formula):
            QMessageBox.warning(self, "æç¤º", "è¯·å®Œæ•´å¡«å†™")
            return
        ok, msg = self.processor.apply_formula(file_path, formula, col, new_col)
        QMessageBox.information(self, "ç»“æœ", msg)

# ---------- å¯åŠ¨ ----------
if __name__ == "__main__":
    app = QApplication(sys.argv)
    win = ExcelToolsApp()
    win.show()
    sys.exit(app.exec_())
